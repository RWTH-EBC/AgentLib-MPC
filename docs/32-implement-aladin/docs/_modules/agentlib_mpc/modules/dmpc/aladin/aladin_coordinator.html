

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>agentlib_mpc.modules.dmpc.aladin.aladin_coordinator &mdash; agentlib_mpc 0.6.6 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/autodoc_pydantic.css" />

  
      <script src="../../../../../_static/jquery.js"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
      <script src="../../../../../_static/doctools.js"></script>
      <script src="../../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            agentlib_mpc
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../PackageReference.html">Package Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">agentlib_mpc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../modules.html">agentlib_mpc.modules</a></li>
          <li class="breadcrumb-item"><a href="../../dmpc.html">agentlib_mpc.modules.dmpc</a></li>
      <li class="breadcrumb-item active">agentlib_mpc.modules.dmpc.aladin.aladin_coordinator</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for agentlib_mpc.modules.dmpc.aladin.aladin_coordinator</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">asdict</span><span class="p">,</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">casadi</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ca</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">sparse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">AgentVariable</span><span class="p">,</span> <span class="n">Source</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">Field</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">agentlib_mpc.modules.dmpc.coordinator</span><span class="w"> </span><span class="kn">import</span> <span class="n">Coordinator</span><span class="p">,</span> <span class="n">CoordinatorConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentlib_mpc.data_structures</span><span class="w"> </span><span class="kn">import</span> <span class="n">coordinator_datatypes</span> <span class="k">as</span> <span class="n">cdt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">agentlib_mpc.modules.dmpc.aladin.aladin_datatypes</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ald</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_AladinStatsTracker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper class to manage ALADIN iteration statistics.&quot;&quot;&quot;</span>

    <span class="n">objective</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">qp_solve_time</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">qp_success</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">primal_residual</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">dual_residual</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">wall_time</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">penalty_parameter_tracker</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">qp_penalty_tracker</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">section_length</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">append_iteration_stats</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">objective</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">primal</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">dual</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">penalty</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">qp_penalty</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append stats collected at the end of an iteration.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objective</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primal_residual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">primal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dual_residual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dual</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wall_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">penalty_parameter_tracker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">penalty</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qp_penalty_tracker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qp_penalty</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">section_length</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">append_qp_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solve_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append stats collected after solving the QP.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qp_solve_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">solve_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qp_success</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">success</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_data_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all tracked data as a dictionary.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;objective&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span>
            <span class="s2">&quot;qp_solve_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp_solve_time</span><span class="p">,</span>
            <span class="s2">&quot;qp_success&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp_success</span><span class="p">,</span>
            <span class="s2">&quot;primal_residual&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">primal_residual</span><span class="p">,</span>
            <span class="s2">&quot;dual_residual&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dual_residual</span><span class="p">,</span>
            <span class="s2">&quot;wall_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">wall_time</span><span class="p">,</span>
            <span class="s2">&quot;penalty_parameter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">penalty_parameter_tracker</span><span class="p">,</span>
            <span class="s2">&quot;qp_penalty&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp_penalty_tracker</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear all tracked data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qp_solve_time</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qp_success</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primal_residual</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dual_residual</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wall_time</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">penalty_parameter_tracker</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qp_penalty_tracker</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">section_length</span> <span class="o">=</span> <span class="mi">0</span>


<div class="viewcode-block" id="ALADINCoordinatorConfig"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.ALADINCoordinatorConfig">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">ALADINCoordinatorConfig</span><span class="p">(</span><span class="n">CoordinatorConfig</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hold the config for ALADINCoordinator&quot;&quot;&quot;</span>

    <span class="n">penalty_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;penalty_factor&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Penalty factor of the ALADIN algorithm. Should be equal &quot;</span>
        <span class="s2">&quot;for all agents.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">iter_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;iter_max&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum number of ALADIN iterations before termination of control &quot;</span>
        <span class="s2">&quot;step.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">qp_penalty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Mu parameter of the ALADIN algorithm.&quot;</span>
    <span class="p">)</span>
    <span class="n">qp_step_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">le</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Constant step size used for multiplier and primal variables &quot;</span>
        <span class="s2">&quot;update.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">qp_solver</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;qp_solver&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;osqp&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;QP solver to use for coordination problem (osqp, qpoases, proxqp)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">qp_solver_verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enable verbose output from QP solver&quot;</span>
    <span class="p">)</span>

    <span class="n">qp_solver_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Additional solver-specific options to pass to the QP solver&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">activation_margin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Threshold for active set detection.&quot;</span>
    <span class="p">)</span>
    <span class="n">regularization_parameter</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">lambda_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">solve_stats_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;aladin_stats.csv&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;File name for the solve stats.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">penalty_variation_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Factor to multiply penalty_parameter (rho) with each iteration.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">max_penalty_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum value for penalty_parameter (rho).&quot;</span>
    <span class="p">)</span>
    <span class="n">qp_penalty_variation_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Factor to multiply qp_penalty (mu) with each iteration.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">max_qp_penalty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">1e8</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum value for qp_penalty (mu).&quot;</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="ALADINCoordinator"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.ALADINCoordinator">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">ALADINCoordinator</span><span class="p">(</span><span class="n">Coordinator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Coordinator implementation for the ALADIN algorithm&quot;&quot;&quot;</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">ALADINCoordinatorConfig</span>
    <span class="n">_stats_tracker</span><span class="p">:</span> <span class="n">_AladinStatsTracker</span>
    <span class="n">_total_objective</span><span class="p">:</span> <span class="nb">float</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Agent</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Source</span><span class="p">,</span> <span class="n">ald</span><span class="o">.</span><span class="n">AgentDictEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_healthy_agents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats_tracker</span> <span class="o">=</span> <span class="n">_AladinStatsTracker</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_objective</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># ALADIN-specific parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">penalty_parameter</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">penalty_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qp_penalty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qp_penalty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_old</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_to_parent</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Enable debugging if save_solve_stats is True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">save_solve_stats</span><span class="p">:</span>
            <span class="n">debug_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">solve_stats_file</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;debug&quot;</span><span class="p">)</span>
            <span class="c1"># self.enable_detailed_debugging(debug_dir)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initial_registration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="n">AgentVariable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handles initial registration of an agent with ALADIN-specific entry type.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_dict</span><span class="p">):</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">ald</span><span class="o">.</span><span class="n">AgentDictEntry</span><span class="p">(</span>  <span class="c1"># Use ALADIN-specific type</span>
                <span class="n">name</span><span class="o">=</span><span class="n">variable</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="n">cdt</span><span class="o">.</span><span class="n">AgentStatus</span><span class="o">.</span><span class="n">pending</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent_dict</span><span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">source</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send_parameters_to_agent</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Coordinator got request from agent </span><span class="si">{</span><span class="n">variable</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2"> and set to &#39;pending&#39;.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_dict</span><span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">cdt</span><span class="o">.</span><span class="n">AgentStatus</span><span class="o">.</span><span class="n">pending</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_agent</span><span class="p">(</span><span class="n">variable</span><span class="o">=</span><span class="n">variable</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_realtime_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implement one step of the ALADIN algorithm in realtime mode.&quot;&quot;&quot;</span>
        <span class="c1"># ------------------</span>
        <span class="c1"># start iteration</span>
        <span class="c1"># ------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cdt</span><span class="o">.</span><span class="n">CoordinatorStatus</span><span class="o">.</span><span class="n">init_iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_algorithm_at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_performance_counter</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="c1"># maybe this will hold information instead of &quot;True&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cdt</span><span class="o">.</span><span class="n">START_ITERATION_C2A</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># check for all_finished here</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wait_time_on_start_iters</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agents_with_status</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">cdt</span><span class="o">.</span><span class="n">AgentStatus</span><span class="o">.</span><span class="n">ready</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Agents available at time </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span>  <span class="c1"># if no agents registered return early</span>

        <span class="c1"># Reset penalty parameters for the new control step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">penalty_parameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">penalty_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qp_penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qp_penalty</span>

        <span class="c1"># Create couplings on first iteration or if agents change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_couplings</span><span class="p">()</span>

        <span class="c1"># ------------------</span>
        <span class="c1"># iteration loop</span>
        <span class="c1"># ------------------</span>
        <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">iter_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># ------------------</span>
            <span class="c1"># optimization</span>
            <span class="c1"># ------------------</span>
            <span class="c1"># send</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cdt</span><span class="o">.</span><span class="n">CoordinatorStatus</span><span class="o">.</span><span class="n">optimization</span>
            <span class="c1"># set all agents to busy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_optimizations</span><span class="p">()</span>

            <span class="c1"># check for all finished here</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_ready</span><span class="p">()</span>

            <span class="c1"># ------------------</span>
            <span class="c1"># perform update steps</span>
            <span class="c1"># ------------------</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cdt</span><span class="o">.</span><span class="n">CoordinatorStatus</span><span class="o">.</span><span class="n">updating</span>
            <span class="n">AQP</span><span class="p">,</span> <span class="n">bQP</span><span class="p">,</span> <span class="n">HQP</span><span class="p">,</span> <span class="n">gQP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_qp_params</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_solve_coordination_qp</span><span class="p">(</span><span class="n">AQP</span><span class="p">,</span> <span class="n">bQP</span><span class="p">,</span> <span class="n">HQP</span><span class="p">,</span> <span class="n">gQP</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_al_step</span><span class="p">()</span>

            <span class="c1"># ------------------</span>
            <span class="c1"># check convergence</span>
            <span class="c1"># ------------------</span>
            <span class="n">converged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_convergence</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">converged</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converged within </span><span class="si">%s</span><span class="s2"> iterations. &quot;</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Did not converge within the maximum number of iterations &quot;</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">. &quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">iter_max</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_up_algorithm</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="n">iteration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cdt</span><span class="o">.</span><span class="n">START_ITERATION_C2A</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># this signals the finish</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fast_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process function for use in fast-as-possible simulations.&quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_non_rt</span><span class="p">()</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># ------------------</span>
            <span class="c1"># start iteration</span>
            <span class="c1"># ------------------</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cdt</span><span class="o">.</span><span class="n">CoordinatorStatus</span><span class="o">.</span><span class="n">init_iterations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_algorithm_at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_performance_counter</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cdt</span><span class="o">.</span><span class="n">START_ITERATION_C2A</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_non_rt</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agents_with_status</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">cdt</span><span class="o">.</span><span class="n">AgentStatus</span><span class="o">.</span><span class="n">ready</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Agents available at time </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">communication_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_algorithm_at</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sampling_time</span> <span class="o">-</span> <span class="n">communication_time</span><span class="p">)</span>
                <span class="k">continue</span>  <span class="c1"># if no agents registered return early</span>

            <span class="c1"># Reset penalty parameters for the new control step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">penalty_parameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">penalty_factor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qp_penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qp_penalty</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">create_couplings</span><span class="p">()</span>

            <span class="c1"># ------------------</span>
            <span class="c1"># iteration loop</span>
            <span class="c1"># ------------------</span>
            <span class="n">iter_</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">iter_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">iter_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># parallel steps optimization</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cdt</span><span class="o">.</span><span class="n">CoordinatorStatus</span><span class="o">.</span><span class="n">optimization</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trigger_optimizations</span><span class="p">()</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_non_rt</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_ready</span><span class="p">()</span>

                <span class="c1"># coordinator update</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cdt</span><span class="o">.</span><span class="n">CoordinatorStatus</span><span class="o">.</span><span class="n">updating</span>
                <span class="n">AQP</span><span class="p">,</span> <span class="n">bQP</span><span class="p">,</span> <span class="n">HQP</span><span class="p">,</span> <span class="n">gQP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_qp_params</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solve_coordination_qp</span><span class="p">(</span><span class="n">AQP</span><span class="p">,</span> <span class="n">bQP</span><span class="p">,</span> <span class="n">HQP</span><span class="p">,</span> <span class="n">gQP</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compute_al_step</span><span class="p">()</span>

                <span class="c1"># check convergence</span>
                <span class="n">converged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_convergence</span><span class="p">(</span><span class="n">iter_</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">converged</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converged within </span><span class="si">%s</span><span class="s2"> iterations. &quot;</span><span class="p">,</span> <span class="n">iter_</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Did not converge within the maximum number of iterations &quot;</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">. &quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">iter_max</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_up_algorithm</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="n">iter_</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cdt</span><span class="o">.</span><span class="n">START_ITERATION_C2A</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># this signals the finish</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cdt</span><span class="o">.</span><span class="n">CoordinatorStatus</span><span class="o">.</span><span class="n">sleeping</span>
            <span class="n">time_spent_on_communication</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_algorithm_at</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sampling_time</span> <span class="o">-</span> <span class="n">time_spent_on_communication</span>
            <span class="p">)</span>

<div class="viewcode-block" id="ALADINCoordinator.init_iteration_callback"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.ALADINCoordinator.init_iteration_callback">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_iteration_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="n">AgentVariable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process an agent&#39;s InitIteration confirmation.&quot;&quot;&quot;</span>
        <span class="n">ag_dict_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confirm_init_iteration</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ag_dict_entry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># if there is a list value, that means we get a shifted trajectory</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">ag_dict_entry</span><span class="o">.</span><span class="n">local_solution</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span>
            <span class="n">ag_dict_entry</span><span class="o">.</span><span class="n">local_target</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span>
        <span class="n">ag_dict_entry</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cdt</span><span class="o">.</span><span class="n">AgentStatus</span><span class="o">.</span><span class="n">ready</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">received_variable</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_send_parameters_to_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="n">AgentVariable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send global parameters to an agent after registration request.&quot;&quot;&quot;</span>
        <span class="n">aladin_parameters</span> <span class="o">=</span> <span class="n">ald</span><span class="o">.</span><span class="n">ALADINParameters</span><span class="p">(</span>
            <span class="n">receiver_agent_id</span><span class="o">=</span><span class="n">variable</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">agent_id</span><span class="p">,</span>
            <span class="n">prediction_horizon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">prediction_horizon</span><span class="p">,</span>
            <span class="n">time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_step</span><span class="p">,</span>
            <span class="n">penalty_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">penalty_factor</span><span class="p">,</span>
            <span class="n">regularization_parameter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">regularization_parameter</span><span class="p">,</span>  <span class="c1"># Added</span>
            <span class="n">activation_margin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">activation_margin</span><span class="p">,</span>  <span class="c1"># Added</span>
        <span class="p">)</span>

        <span class="n">message</span> <span class="o">=</span> <span class="n">cdt</span><span class="o">.</span><span class="n">RegistrationMessage</span><span class="p">(</span>
            <span class="n">agent_id</span><span class="o">=</span><span class="n">variable</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="n">aladin_parameters</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cdt</span><span class="o">.</span><span class="n">REGISTRATION_C2A</span><span class="p">,</span> <span class="n">asdict</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

<div class="viewcode-block" id="ALADINCoordinator.register_agent"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.ALADINCoordinator.register_agent">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">register_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="n">AgentVariable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register an agent after it sends its initial data.&quot;&quot;&quot;</span>
        <span class="n">reg_msg</span><span class="p">:</span> <span class="n">ald</span><span class="o">.</span><span class="n">RegistrationA2C</span> <span class="o">=</span> <span class="n">ald</span><span class="o">.</span><span class="n">RegistrationA2C</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">source</span>
        <span class="n">ag_dict_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_dict</span><span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">source</span><span class="p">]</span>
        <span class="n">ag_dict_entry</span><span class="o">.</span><span class="n">opt_var_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_msg</span><span class="o">.</span><span class="n">local_solution</span><span class="p">)</span>
        <span class="n">ag_dict_entry</span><span class="o">.</span><span class="n">local_solution</span> <span class="o">=</span> <span class="n">reg_msg</span><span class="o">.</span><span class="n">local_solution</span>
        <span class="n">ag_dict_entry</span><span class="o">.</span><span class="n">local_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reg_msg</span><span class="o">.</span><span class="n">local_solution</span><span class="p">)</span>
        <span class="n">ag_dict_entry</span><span class="o">.</span><span class="n">local_update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">reg_msg</span><span class="o">.</span><span class="n">local_solution</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ag_dict_entry</span><span class="o">.</span><span class="n">coup_vars</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">reg_msg</span><span class="o">.</span><span class="n">coup_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># loop over coupling variables of this agent</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">traj</span> <span class="ow">in</span> <span class="n">ag_dict_entry</span><span class="o">.</span><span class="n">coup_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ag_dict_entry</span><span class="o">.</span><span class="n">multipliers</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># set agent from pending to standby</span>
        <span class="n">ag_dict_entry</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cdt</span><span class="o">.</span><span class="n">AgentStatus</span><span class="o">.</span><span class="n">standby</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Coordinator successfully registered agent </span><span class="si">{</span><span class="n">variable</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ALADINCoordinator.trigger_optimizations"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.ALADINCoordinator.trigger_optimizations">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">trigger_optimizations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trigger optimizations for all agents with ready status.&quot;&quot;&quot;</span>
        <span class="c1"># create an iterator for all agents which are ready for this round</span>
        <span class="n">active_agents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_agents</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_objective</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># reset objective tracker</span>

        <span class="c1"># aggregate and send trajectories per agent</span>
        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">active_agents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># package all coupling inputs needed for an agent</span>
            <span class="n">coordi_to_agent</span> <span class="o">=</span> <span class="n">ald</span><span class="o">.</span><span class="n">CoordinatorToAgent</span><span class="p">(</span>
                <span class="n">z</span><span class="o">=</span><span class="n">agent</span><span class="o">.</span><span class="n">local_target</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                <span class="n">lam</span><span class="o">=</span><span class="n">agent</span><span class="o">.</span><span class="n">multipliers</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">agent_id</span><span class="p">,</span>
                <span class="n">rho</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">penalty_parameter</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending to </span><span class="si">%s</span><span class="s2"> with source </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Set </span><span class="si">%s</span><span class="s2"> to busy.&quot;</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># send values</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cdt</span><span class="o">.</span><span class="n">AgentStatus</span><span class="o">.</span><span class="n">busy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cdt</span><span class="o">.</span><span class="n">OPTIMIZATION_C2A</span><span class="p">,</span> <span class="n">coordi_to_agent</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span></div>

<div class="viewcode-block" id="ALADINCoordinator.optim_results_callback"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.ALADINCoordinator.optim_results_callback">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">optim_results_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="n">AgentVariable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process the results from a local optimization.&quot;&quot;&quot;</span>
        <span class="n">local_result</span> <span class="o">=</span> <span class="n">ald</span><span class="o">.</span><span class="n">AgentToCoordinator</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="c1"># Accumulate objective</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_objective</span> <span class="o">+=</span> <span class="n">local_result</span><span class="o">.</span><span class="n">objective</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_dict</span><span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">source</span><span class="p">]</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">hessian</span> <span class="o">=</span> <span class="n">local_result</span><span class="o">.</span><span class="n">H</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">local_solution</span> <span class="o">=</span> <span class="n">local_result</span><span class="o">.</span><span class="n">x</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">jacobian</span> <span class="o">=</span> <span class="n">local_result</span><span class="o">.</span><span class="n">J</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">gradient</span> <span class="o">=</span> <span class="n">local_result</span><span class="o">.</span><span class="n">g</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cdt</span><span class="o">.</span><span class="n">AgentStatus</span><span class="o">.</span><span class="n">ready</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">received_variable</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_active_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Source</span><span class="p">,</span> <span class="n">ald</span><span class="o">.</span><span class="n">AgentDictEntry</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a dictionary of active agents (with ready status).&quot;&quot;&quot;</span>
        <span class="n">active_agents</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">ag</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ag</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">cdt</span><span class="o">.</span><span class="n">AgentStatus</span><span class="o">.</span><span class="n">ready</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_healthy_agents</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">active_agents</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_healthy_agents</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;There was a change in active Agents, this is currently not supported&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">active_agents</span>

<div class="viewcode-block" id="ALADINCoordinator.create_couplings"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.ALADINCoordinator.create_couplings">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_couplings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create coupling matrices for all agents.&quot;&quot;&quot;</span>
        <span class="c1"># Check agents that are currently registered and on standby</span>
        <span class="n">active_agents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_agents</span><span class="p">()</span>
        <span class="c1"># if agents are the same as last time, we do not need to remake couplings</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">active_agents</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_healthy_agents</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># if we got here, we need to redo the couplings and remember the healthy agents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_healthy_agents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">active_agents</span><span class="p">)</span>
        <span class="n">global_var_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># assign parent / child on coupling variables</span>
        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">active_agents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">coup_vars</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_to_parent</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">alias_to_parent</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">coup_vars_parent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">coup_vars_child</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>

        <span class="c1"># build the coupling matrices</span>
        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">child_entry</span> <span class="ow">in</span> <span class="n">active_agents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">child_entry</span><span class="p">:</span> <span class="n">ald</span><span class="o">.</span><span class="n">AgentDictEntry</span>
            <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">child_entry</span><span class="o">.</span><span class="n">coup_vars_child</span><span class="p">:</span>
                <span class="n">parent_src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_to_parent</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
                <span class="n">parent_entry</span> <span class="o">=</span> <span class="n">active_agents</span><span class="p">[</span><span class="n">parent_src</span><span class="p">]</span>
                <span class="n">parent_indices</span> <span class="o">=</span> <span class="n">parent_entry</span><span class="o">.</span><span class="n">coup_vars</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
                <span class="n">child_indices</span> <span class="o">=</span> <span class="n">child_entry</span><span class="o">.</span><span class="n">coup_vars</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parent_indices</span><span class="p">):</span>
                    <span class="n">parent_entry</span><span class="o">.</span><span class="n">sparse_builder</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                        <span class="n">value</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">column</span><span class="o">=</span><span class="n">parent_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">row</span><span class="o">=</span><span class="n">global_var_len</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">child_entry</span><span class="o">.</span><span class="n">sparse_builder</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                        <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">column</span><span class="o">=</span><span class="n">child_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">row</span><span class="o">=</span><span class="n">global_var_len</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">global_var_len</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">active_agents</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">finalize_matrix</span><span class="p">(</span><span class="n">global_var_len</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">global_var_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_qp_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A_sparsity</span><span class="p">,</span> <span class="n">H_sparsity</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create and configure a QP solver based on settings in config.&quot;&quot;&quot;</span>
        <span class="n">cqp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">A_sparsity</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="n">H_sparsity</span><span class="p">}</span>
        <span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qp_solver</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Basic options that apply to most solvers</span>
        <span class="n">solver_options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;error_on_fail&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;print_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qp_solver_verbose</span><span class="p">,</span>
            <span class="n">solver</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>

        <span class="c1"># Solver-specific options</span>
        <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;osqp&quot;</span><span class="p">:</span>
            <span class="n">solver_options</span><span class="p">[</span><span class="n">solver</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qp_solver_verbose</span><span class="p">,</span>
                    <span class="s2">&quot;eps_abs&quot;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
                    <span class="s2">&quot;eps_rel&quot;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
                    <span class="s2">&quot;polish&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;max_iter&quot;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;qpoases&quot;</span><span class="p">:</span>
            <span class="n">solver_options</span><span class="p">[</span><span class="n">solver</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;printLevel&quot;</span><span class="p">:</span> <span class="s2">&quot;high&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qp_solver_verbose</span> <span class="k">else</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;enableRegularisation&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;proxqp&quot;</span><span class="p">:</span>
            <span class="n">solver_options</span><span class="p">[</span><span class="n">solver</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qp_solver_verbose</span><span class="p">,</span>
                    <span class="s2">&quot;eps_abs&quot;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
                    <span class="s2">&quot;eps_rel&quot;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># Override with any user-specified options</span>
        <span class="n">solver_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qp_solver_options</span><span class="p">)</span>

        <span class="c1"># Create and return solver</span>
        <span class="k">return</span> <span class="n">ca</span><span class="o">.</span><span class="n">conic</span><span class="p">(</span><span class="s2">&quot;QPSolver&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qp_solver</span><span class="p">,</span> <span class="n">cqp</span><span class="p">,</span> <span class="n">solver_options</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_solve_coordination_qp</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">AQP</span><span class="p">:</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">,</span>
        <span class="n">bQP</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">HQP</span><span class="p">:</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">,</span>
        <span class="n">gQP</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Solve the coordination QP problem.&quot;&quot;&quot;</span>

        <span class="c1"># Create solver with appropriate options</span>
        <span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_qp_solver</span><span class="p">(</span>
            <span class="n">A_sparsity</span><span class="o">=</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">(</span><span class="n">AQP</span><span class="p">)</span><span class="o">.</span><span class="n">sparsity</span><span class="p">(),</span> <span class="n">H_sparsity</span><span class="o">=</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">(</span><span class="n">HQP</span><span class="p">)</span><span class="o">.</span><span class="n">sparsity</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Solve the QP and track time/success</span>
        <span class="n">qp_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span>
            <span class="n">h</span><span class="o">=</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">(</span><span class="n">HQP</span><span class="p">),</span> <span class="n">g</span><span class="o">=</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">(</span><span class="n">gQP</span><span class="p">),</span> <span class="n">a</span><span class="o">=</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">(</span><span class="n">AQP</span><span class="p">),</span> <span class="n">lba</span><span class="o">=</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">(</span><span class="n">bQP</span><span class="p">),</span> <span class="n">uba</span><span class="o">=</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">(</span><span class="n">bQP</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">qp_solve_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">qp_start_time</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
        <span class="c1"># Use &#39;success&#39; field, default to False if not present or solver failed</span>
        <span class="n">qp_success</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats_tracker</span><span class="o">.</span><span class="n">append_qp_stats</span><span class="p">(</span>
            <span class="n">solve_time</span><span class="o">=</span><span class="n">qp_solve_time</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="n">qp_success</span>
        <span class="p">)</span>

        <span class="c1"># Conditionally log stats only if debugging is enabled</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;debug_enabled&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_enabled</span><span class="p">:</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;QP solver stats: </span><span class="si">{</span><span class="n">stats</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Process results</span>
        <span class="n">primal_solution</span> <span class="o">=</span> <span class="n">solution</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        <span class="n">dual_solution</span> <span class="o">=</span> <span class="n">solution</span><span class="p">[</span><span class="s2">&quot;lam_a&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_</span>
        <span class="c1"># lambda is set here to full step. We keep old lambda, so we can do partial</span>
        <span class="c1"># step later</span>
        <span class="n">uncapped_lambda</span> <span class="o">=</span> <span class="n">dual_solution</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_</span><span class="p">)]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

        <span class="c1"># Apply capping to prevent extreme multipliers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cap_multipliers</span><span class="p">(</span><span class="n">uncapped_lambda</span><span class="p">)</span>

        <span class="c1"># split solution to agents</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_agents</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="n">entry</span><span class="o">.</span><span class="n">opt_var_length</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">local_update</span> <span class="o">=</span> <span class="n">primal_solution</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">end</span>

        <span class="k">return</span> <span class="n">primal_solution</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the algorithm has converged.&quot;&quot;&quot;</span>
        <span class="c1"># Implement ALADIN-specific convergence check</span>
        <span class="c1"># For now, using a simple implementation based on the norm of updates</span>
        <span class="n">active_agents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_agents</span><span class="p">()</span>

        <span class="c1"># Compute primal and dual residuals</span>
        <span class="n">primal_residual</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dual_residual</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">active_agents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Primal residual: norm of updates</span>
            <span class="n">primal_update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">local_update</span><span class="p">)</span>
            <span class="n">primal_residual</span> <span class="o">+=</span> <span class="n">primal_update</span><span class="o">**</span><span class="mi">2</span>

            <span class="c1"># Dual residual: norm of multiplier changes</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dual_update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_old</span><span class="p">)</span>
                <span class="n">dual_residual</span> <span class="o">+=</span> <span class="n">dual_update</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">primal_residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">primal_residual</span><span class="p">)</span>
        <span class="n">dual_residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dual_residual</span><span class="p">)</span> <span class="k">if</span> <span class="n">dual_residual</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Track iteration stats</span>
        <span class="n">wall_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_performance_counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats_tracker</span><span class="o">.</span><span class="n">append_iteration_stats</span><span class="p">(</span>
            <span class="n">objective</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_total_objective</span><span class="p">,</span>
            <span class="n">primal</span><span class="o">=</span><span class="n">primal_residual</span><span class="p">,</span>
            <span class="n">dual</span><span class="o">=</span><span class="n">dual_residual</span><span class="p">,</span>
            <span class="n">time</span><span class="o">=</span><span class="n">wall_time</span><span class="p">,</span>
            <span class="n">penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">penalty_parameter</span><span class="p">,</span>
            <span class="n">qp_penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qp_penalty</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Finished iteration </span><span class="si">%s</span><span class="s2"> . </span><span class="se">\n</span><span class="s2"> Primal residual: </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> Dual residual: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">iteration</span><span class="p">,</span>
            <span class="n">primal_residual</span><span class="p">,</span>
            <span class="n">dual_residual</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Log detailed convergence info if debugging is enabled</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;debug_enabled&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_convergence_metrics</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">primal_residual</span><span class="p">,</span> <span class="n">dual_residual</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_agent_updates</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">save_iter_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_stats_aladin</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="n">iteration</span><span class="p">)</span>

        <span class="c1"># Update penalty parameters for the next iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">penalty_parameter</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">penalty_parameter</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">penalty_variation_factor</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_penalty_factor</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qp_penalty</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qp_penalty</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qp_penalty_variation_factor</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_qp_penalty</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Check convergence against tolerance</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">primal_residual</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">abs_tol</span>
            <span class="ow">and</span> <span class="n">dual_residual</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">abs_tol</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ALADINCoordinator.setup_qp_params"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.ALADINCoordinator.setup_qp_params">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_qp_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the parameters for the coordination QP.&quot;&quot;&quot;</span>
        <span class="n">active_agents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_agents</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

        <span class="c1"># Construct A matrix</span>
        <span class="n">full_coupling_matrix</span><span class="p">:</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">coupling_matrix</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">active_agents</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
        <span class="n">len_global_var</span> <span class="o">=</span> <span class="n">full_coupling_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Compute rhsQP vector</span>
        <span class="n">full_local_sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">local_solution</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">active_agents</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">qp_right_hand_side</span> <span class="o">=</span> <span class="o">-</span><span class="n">full_coupling_matrix</span> <span class="o">@</span> <span class="n">full_local_sol</span>

        <span class="c1"># Construct HQP matrix with symmetry enforcement</span>
        <span class="n">hessians</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">active_agents</span><span class="p">:</span>
            <span class="c1"># Ensure each agent&#39;s Hessian is symmetric</span>
            <span class="n">agent_hessian</span> <span class="o">=</span> <span class="n">ensure_symmetric</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">hessian</span><span class="p">)</span>
            <span class="n">hessians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_hessian</span><span class="p">)</span>

        <span class="c1"># Add penalty term</span>
        <span class="n">qp_pen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp_penalty</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">penalty_hessian</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">([</span><span class="n">qp_pen</span><span class="p">]</span> <span class="o">*</span> <span class="n">len_global_var</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csc&quot;</span><span class="p">)</span>
        <span class="n">hessians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">penalty_hessian</span><span class="p">)</span>

        <span class="c1"># Create block diagonal Hessian</span>
        <span class="n">HQP</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">block_diag</span><span class="p">(</span><span class="n">hessians</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csc&quot;</span><span class="p">)</span>

        <span class="c1"># Final symmetry check on full HQP</span>
        <span class="n">HQP</span> <span class="o">=</span> <span class="n">ensure_symmetric</span><span class="p">(</span><span class="n">HQP</span><span class="p">)</span>

        <span class="c1"># Construct JacCon matrix</span>
        <span class="n">jac_con</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">block_diag</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">jacobian</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">active_agents</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csc&quot;</span><span class="p">)</span>

        <span class="c1"># Check condition number of JacCon</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;debug_enabled&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_enabled</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">jac_con</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cond_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">jac_con</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cond_num</span> <span class="o">&gt;</span> <span class="mf">1e8</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;High condition number in constraints: </span><span class="si">{</span><span class="n">cond_num</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Construct AQP matrix</span>
        <span class="n">number_of_active_constraints</span> <span class="o">=</span> <span class="n">jac_con</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">AQP</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">sparse</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">full_coupling_matrix</span><span class="p">,</span> <span class="o">-</span><span class="n">sparse</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">len_global_var</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csc&quot;</span><span class="p">)]</span>
                <span class="p">),</span>
                <span class="n">sparse</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">jac_con</span><span class="p">,</span>
                        <span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">number_of_active_constraints</span><span class="p">,</span> <span class="n">len_global_var</span><span class="p">)</span>
                        <span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">tocsc</span><span class="p">()</span>

        <span class="c1"># Construct bQP vector</span>
        <span class="n">bQP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span><span class="n">qp_right_hand_side</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_active_constraints</span><span class="p">,</span> <span class="mi">1</span><span class="p">))]</span>
        <span class="p">)</span>

        <span class="c1"># Construct gQP vector</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">gradient</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">active_agents</span><span class="p">))</span>
        <span class="n">gradients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_</span><span class="p">)</span>
        <span class="n">gQP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">gradients</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">AQP</span><span class="p">,</span> <span class="n">bQP</span><span class="p">,</span> <span class="n">HQP</span><span class="p">,</span> <span class="n">gQP</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_cap_multipliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multipliers</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cap multiplier values to prevent numerical issues.&quot;&quot;&quot;</span>
        <span class="n">capped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">multipliers</span><span class="p">)</span>

        <span class="c1"># Find extreme values</span>
        <span class="n">extreme_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">capped</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda_max</span>

        <span class="c1"># Cap them while preserving sign</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">extreme_indices</span><span class="p">):</span>
            <span class="n">capped</span><span class="p">[</span><span class="n">extreme_indices</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">capped</span><span class="p">[</span><span class="n">extreme_indices</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda_max</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Capped </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extreme_indices</span><span class="p">)</span><span class="si">}</span><span class="s2"> extreme multiplier values&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">capped</span>

<div class="viewcode-block" id="ALADINCoordinator.compute_al_step"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.ALADINCoordinator.compute_al_step">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_al_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the ALADIN step.&quot;&quot;&quot;</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qp_step_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_old</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_old</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_agents</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">local_target</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">local_target</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">local_solution</span> <span class="o">-</span> <span class="n">entry</span><span class="o">.</span><span class="n">local_target</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">entry</span><span class="o">.</span><span class="n">local_update</span>
            <span class="p">)</span>
            <span class="n">full_multiplier</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">entry</span><span class="o">.</span><span class="n">coupling_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">coup_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">multipliers</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_multiplier</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span></div>

<div class="viewcode-block" id="ALADINCoordinator.enable_detailed_debugging"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.ALADINCoordinator.enable_detailed_debugging">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">enable_detailed_debugging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;debug_logs&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable detailed debugging output for ALADIN algorithm.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug_log_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_log_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_enabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_debug_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Setup a specialized debug logger</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

        <span class="n">debug_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">_debug&quot;</span><span class="p">)</span>
        <span class="n">debug_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">file_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_log_dir</span> <span class="o">/</span> <span class="s2">&quot;aladin_debug.log&quot;</span><span class="p">)</span>
        <span class="n">file_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">debug_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span> <span class="o">=</span> <span class="n">debug_logger</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Detailed debugging enabled for ALADIN&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ALADINCoordinator.log_qp_solution"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.ALADINCoordinator.log_qp_solution">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_qp_solution</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">AQP</span><span class="p">,</span> <span class="n">bQP</span><span class="p">,</span> <span class="n">HQP</span><span class="p">,</span> <span class="n">gQP</span><span class="p">,</span> <span class="n">primal_solution</span><span class="p">,</span> <span class="n">dual_solution</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log detailed information about QP solution.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;debug_enabled&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_enabled</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="c1"># Create iteration directory</span>
        <span class="n">iter_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_log_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;iteration_</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">iter_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Log matrices to files (summary information due to size)</span>
        <span class="n">matrices_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;AQP_shape&quot;</span><span class="p">:</span> <span class="n">AQP</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="s2">&quot;AQP_nnz&quot;</span><span class="p">:</span> <span class="n">AQP</span><span class="o">.</span><span class="n">nnz</span><span class="p">,</span>
            <span class="s2">&quot;AQP_density&quot;</span><span class="p">:</span> <span class="n">AQP</span><span class="o">.</span><span class="n">nnz</span> <span class="o">/</span> <span class="p">(</span><span class="n">AQP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">AQP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="s2">&quot;HQP_shape&quot;</span><span class="p">:</span> <span class="n">HQP</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="s2">&quot;HQP_nnz&quot;</span><span class="p">:</span> <span class="n">HQP</span><span class="o">.</span><span class="n">nnz</span><span class="p">,</span>
            <span class="s2">&quot;HQP_density&quot;</span><span class="p">:</span> <span class="n">HQP</span><span class="o">.</span><span class="n">nnz</span> <span class="o">/</span> <span class="p">(</span><span class="n">HQP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">HQP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="s2">&quot;bQP_shape&quot;</span><span class="p">:</span> <span class="n">bQP</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="s2">&quot;gQP_shape&quot;</span><span class="p">:</span> <span class="n">gQP</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">iter_dir</span> <span class="o">/</span> <span class="s2">&quot;matrices_info.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">matrices_info</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Log solution vectors</span>
        <span class="n">dual_solution</span> <span class="o">=</span> <span class="n">dual_solution</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">iter_dir</span> <span class="o">/</span> <span class="s2">&quot;primal_solution.npy&quot;</span><span class="p">,</span> <span class="n">primal_solution</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">iter_dir</span> <span class="o">/</span> <span class="s2">&quot;dual_solution.npy&quot;</span><span class="p">,</span> <span class="n">dual_solution</span><span class="p">)</span>

        <span class="c1"># Create visualizations</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">primal_solution</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Primal solution vector (iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Variable index&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dual_solution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dual_solution</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">dual_solution</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dual_solution</span><span class="p">,</span> <span class="s2">&quot;toarray&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">dual_solution</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dual solution vector (iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Constraint index&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">iter_dir</span> <span class="o">/</span> <span class="s2">&quot;qp_solution.png&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Log solution statistics</span>
        <span class="n">solution_stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;primal_solution_norm&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">primal_solution</span><span class="p">)),</span>
            <span class="s2">&quot;primal_solution_min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">primal_solution</span><span class="p">)),</span>
            <span class="s2">&quot;primal_solution_max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">primal_solution</span><span class="p">)),</span>
            <span class="s2">&quot;dual_solution_norm&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                    <span class="n">dual_solution</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dual_solution</span><span class="p">,</span> <span class="s2">&quot;toarray&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">dual_solution</span>
                <span class="p">)</span>
            <span class="p">),</span>
        <span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">iter_dir</span> <span class="o">/</span> <span class="s2">&quot;solution_stats.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">solution_stats</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;QP solution logged for iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ALADINCoordinator.log_agent_updates"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.ALADINCoordinator.log_agent_updates">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_agent_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log detailed information about agent updates.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;debug_enabled&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_enabled</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

        <span class="c1"># Create iteration directory</span>
        <span class="n">iter_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_log_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;iteration_</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">iter_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Collect information about each agent</span>
        <span class="n">agent_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_agents</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">agent_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Convert to numpy arrays if they&#39;re lists</span>
            <span class="n">local_solution</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">local_solution</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">local_solution</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">agent</span><span class="o">.</span><span class="n">local_solution</span>
            <span class="p">)</span>
            <span class="n">local_update</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">local_update</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">local_update</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">agent</span><span class="o">.</span><span class="n">local_update</span>
            <span class="p">)</span>
            <span class="n">local_target</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">local_target</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">local_target</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">agent</span><span class="o">.</span><span class="n">local_target</span>
            <span class="p">)</span>

            <span class="c1"># Flatten if necessary (for 2D arrays)</span>
            <span class="k">if</span> <span class="n">local_solution</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">local_solution</span> <span class="o">=</span> <span class="n">local_solution</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">local_update</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">local_update</span> <span class="o">=</span> <span class="n">local_update</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">local_target</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">local_target</span> <span class="o">=</span> <span class="n">local_target</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="n">agent_data</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;local_solution_norm&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">local_solution</span><span class="p">)),</span>
                <span class="s2">&quot;local_update_norm&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">local_update</span><span class="p">)),</span>
                <span class="s2">&quot;local_target_norm&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">local_target</span><span class="p">)),</span>
                <span class="s2">&quot;hessian_condition&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                        <span class="n">agent</span><span class="o">.</span><span class="n">hessian</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">hessian</span><span class="p">,</span> <span class="s2">&quot;toarray&quot;</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">agent</span><span class="o">.</span><span class="n">hessian</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="s2">&quot;jacobian_shape&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jacobian</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jacobian</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="s2">&quot;gradient_norm&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">gradient</span><span class="p">)),</span>
            <span class="p">}</span>

            <span class="c1"># Save agent data as arrays</span>
            <span class="n">agent_dir</span> <span class="o">=</span> <span class="n">iter_dir</span> <span class="o">/</span> <span class="n">agent_id</span>
            <span class="n">agent_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">agent_dir</span> <span class="o">/</span> <span class="s2">&quot;local_solution.npy&quot;</span><span class="p">,</span> <span class="n">local_solution</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">agent_dir</span> <span class="o">/</span> <span class="s2">&quot;local_update.npy&quot;</span><span class="p">,</span> <span class="n">local_update</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">agent_dir</span> <span class="o">/</span> <span class="s2">&quot;local_target.npy&quot;</span><span class="p">,</span> <span class="n">local_target</span><span class="p">)</span>

            <span class="c1"># Create visualization of agent trajectories</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">local_solution</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2"> local solution (iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Variable index&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>

            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">local_update</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2"> local update (iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Variable index&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>

            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">local_target</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2"> local target (iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Variable index&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">agent_dir</span> <span class="o">/</span> <span class="s2">&quot;trajectories.png&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># Log coupling variables specifically</span>
            <span class="n">coupling_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">idx_array</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">coup_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Convert indices to a list for more reliable indexing</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">idx_array</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx_array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">idx_array</span>
                <span class="p">)</span>

                <span class="c1"># Handle extraction of values based on indices - safely</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_solution</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="n">local_solution</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Manual extraction if local_solution is a list</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">local_solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">])</span>

                <span class="n">multipliers</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">multipliers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
                <span class="n">multipliers_array</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">multipliers</span><span class="p">)</span> <span class="k">if</span> <span class="n">multipliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>

                <span class="n">coupling_data</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;indices&quot;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span>
                    <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">values</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;multipliers&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">multipliers_array</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">multipliers_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;values_norm&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
                    <span class="s2">&quot;multipliers_norm&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">multipliers_array</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">multipliers_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">),</span>
                <span class="p">}</span>

                <span class="c1"># Create coupling visualization</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Coupling </span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s2"> values (agent </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">, iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time step&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">multipliers_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">multipliers_array</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Coupling </span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s2"> multipliers (agent </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">, iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time step&quot;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">agent_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;coupling_</span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">agent_dir</span> <span class="o">/</span> <span class="s2">&quot;coupling_data.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">coupling_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">NumpyEncoder</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">iter_dir</span> <span class="o">/</span> <span class="s2">&quot;agent_data.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">agent_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent updates logged for iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ALADINCoordinator.log_convergence_metrics"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.ALADINCoordinator.log_convergence_metrics">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_convergence_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">primal_residual</span><span class="p">,</span> <span class="n">dual_residual</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log detailed convergence metrics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;debug_enabled&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_enabled</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Add to iteration data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_debug_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">iteration</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="s2">&quot;primal_residual&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">primal_residual</span><span class="p">),</span>
                <span class="s2">&quot;dual_residual&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">dual_residual</span><span class="p">),</span>
                <span class="s2">&quot;penalty_parameter&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">penalty_parameter</span><span class="p">),</span>
                <span class="s2">&quot;qp_penalty&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qp_penalty</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Save to CSV</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration_debug_data</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_log_dir</span> <span class="o">/</span> <span class="s2">&quot;convergence_metrics.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Create convergence plots</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;primal_residual&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Primal residual&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Residual (log scale)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;dual_residual&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Dual residual&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Residual (log scale)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_log_dir</span> <span class="o">/</span> <span class="s2">&quot;convergence.png&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Convergence metrics logged for iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_stats_aladin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save iteration statistics to a file.&quot;&quot;&quot;</span>
        <span class="c1"># Get data from the tracker</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats_tracker</span><span class="o">.</span><span class="n">get_data_dict</span><span class="p">()</span>
        <span class="c1"># Save using the parent method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_stats</span><span class="p">(</span>
            <span class="n">iterations</span><span class="o">=</span><span class="n">iterations</span><span class="p">,</span>
            <span class="n">data_dict</span><span class="o">=</span><span class="n">data_dict</span><span class="p">,</span>
            <span class="n">section_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stats_tracker</span><span class="o">.</span><span class="n">section_length</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Clear the tracker for the next time step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats_tracker</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_wrap_up_algorithm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterations</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up at the end of an algorithm execution.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_stats_aladin</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="n">iterations</span><span class="p">)</span>
        <span class="c1"># Reset penalty parameters for the next control step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">penalty_parameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">penalty_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qp_penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">qp_penalty</span></div>


<span class="c1"># Helper class for JSON serialization of numpy arrays</span>
<div class="viewcode-block" id="NumpyEncoder"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.NumpyEncoder">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">NumpyEncoder</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">):</span>
<div class="viewcode-block" id="NumpyEncoder.default"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.NumpyEncoder.default">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ensure_symmetric"><a class="viewcode-back" href="../../../../../code/agentlib_mpc.modules.dmpc.aladin.html#agentlib_mpc.modules.dmpc.aladin.aladin_coordinator.ensure_symmetric">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">ensure_symmetric</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure a matrix is symmetric by averaging it with its transpose.</span>

<span class="sd">    Args:</span>
<span class="sd">        matrix: Input matrix (sparse, dense, or list)</span>
<span class="sd">        tol: Tolerance for checking symmetry</span>

<span class="sd">    Returns:</span>
<span class="sd">        Symmetric matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert list to numpy array if needed</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
        <span class="c1"># For sparse matrices</span>
        <span class="n">matrix_array</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">matrix_array</span><span class="p">,</span> <span class="n">matrix_array</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">tol</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">matrix</span>  <span class="c1"># Already symmetric within tolerance</span>

        <span class="c1"># Make symmetric by averaging with transpose</span>
        <span class="n">symmetric</span> <span class="o">=</span> <span class="p">(</span><span class="n">matrix</span> <span class="o">+</span> <span class="n">matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">(</span><span class="n">symmetric</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For dense matrices</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">matrix</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">tol</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">matrix</span>  <span class="c1"># Already symmetric within tolerance</span>

        <span class="c1"># Make symmetric by averaging with transpose</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">matrix</span> <span class="o">+</span> <span class="n">matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, AGENT-Project Associates.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>